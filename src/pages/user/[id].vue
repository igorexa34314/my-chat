<template>
	<div v-if="!userdata || !Object.keys(userdata).length" class="text-h5 pa-4 mt-5">Пользователь не найден</div>
	<div v-else>
		<v-card class="pa-5">
			<v-card-title>
				<v-row align="center" justify="space-between">
					<v-col cols="10" class="d-flex align-center">
						<v-img :lazy-src="defaultAvatar" :src="(userdata?.info?.photoURL)?.toString()" alt="Фото"
							max-width="100px" class="mr-5" />
						<div class="">
							<h2 class="mb-2">{{ userdata?.info?.displayName }}</h2>
							<div class="d-flex align-center mt-2">
								<span class="text-subtitle-1 mr-2">Пол:</span>
								<small><v-icon
										:icon="userdata?.info?.gender === 'unknown' ? 'mdi-help' : userdata?.info?.gender === 'male' ? 'mdi-gender-male' : 'mdi-gender-female'"></v-icon>
								</small>
							</div>
						</div>
					</v-col>
					<v-col class="" v-if="route.params.id !== uid">
						<v-tooltip location="bottom">
							<template v-slot:activator="{ props }">
								<v-btn v-bind="props" size="x-large" variant="text" icon="mdi-message-text" @click="goToChat" />
							</template>
							<span class="text-subtitle-2 font-weight-medium">Перейти в сообщения</span>
						</v-tooltip>
						<v-tooltip location="bottom">
							<template v-slot:activator="{ props }">
								<v-btn v-bind="props" size="x-large" variant="text" icon="mdi-account-plus-outline" class="ml-2"
									@click="addToFriend" />
							</template>
							<span class="text-subtitle-2 font-weight-medium">Добавить в друзья</span>
						</v-tooltip>
					</v-col>
				</v-row>
			</v-card-title>
		</v-card>
	</div>
</template>

<script setup lang="ts">
import messages from '@/utils/messages.json';
import { computed } from 'vue';
import { useUserdataStore } from '@/stores/userdata';
import { useRoute, useRouter } from 'vue-router';
import { useAuth } from '@/composables/auth';
import { useChat } from '@/composables/chat';
import { useMeta } from 'vue-meta';
import { useSnackbarStore } from '@/stores/snackbar';

const defaultAvatar = new URL('@/assets/img/default_user_avatar.jpg', import.meta.url).href;

const { getUid } = useAuth();
const { showMessage } = useSnackbarStore();
const { joinPrivateChat } = useChat();
const route = useRoute();
const { push } = useRouter();
const userdataStore = useUserdataStore();

const userdata = await userdataStore.getUserdataById(route.params.id as string);
const uid = await getUid();

//Dynamic page title
useMeta(computed(() => {
	if (userdata && Object.keys(userdata).length) {
		return { title: `${userdata?.info?.displayName}` }
	}
	return { title: 'Профиль' }
}));

const goToChat = async () => {
	try {
		const chatId = await joinPrivateChat(route.params.id as string);
		push({ name: 'chat-id', params: { id: chatId } });
	} catch (e) {
		showMessage(messages[e] || e, 'red-darken-3', 2000);
	}
};
const addToFriend = async () => {
	if (route.params.id) {
		await userdataStore.addToFriend(route.params.id as string);
	}
}
</script>

<style lang="scss" scoped></style>